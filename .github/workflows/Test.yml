name: Research V4 Tests

on:
  #push:
    #branches: [ main, develop ]
    #paths:
      #- 'V4/**'
      #- 'requirements.txt'
      #- '.github/workflows/test.yml'
  #pull_request:
    #branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt

    - name: Create directory structure
      run: |
        mkdir -p V4/config
        mkdir -p V4/db
        mkdir -p _posts

    - name: Verify imports
      run: |
        python -c "from V4.ConfigManager import ConfigManager; print('✓ ConfigManager')"
        python -c "from V4.FloraDatabase import FloraDatabase; print('✓ FloraDatabase')"
        python -c "from V4.RagSys import RAGSystem; print('✓ RAGSystem')"
        python -c "from V4.ArtGenSys import EnhancedPlantArticleGenerator; print('✓ ArtGenSys')"

    - name: Test ConfigManager
      run: |
        python -c "
        from V4.ConfigManager import ConfigManager
        config = ConfigManager(verbose=True)
        assert config.get_current_domain() == 'botany'
        assert 'botany' in config.get_available_domains()
        print('✓ ConfigManager tests passed')
        "

    - name: Test FloraDatabase
      run: |
        python -c "
        from V4.FloraDatabase import FloraDatabase
        from V4.ConfigManager import ConfigManager
        config = ConfigManager()
        db = FloraDatabase(config)
        assert db.create_default_schema() == True
        stats = db.get_statistics()
        assert isinstance(stats, dict)
        print('✓ FloraDatabase tests passed')
        "

    - name: Test RAGSystem initialization
      run: |
        python -c "
        from V4.RagSys import RAGSystem
        from V4.ConfigManager import ConfigManager
        config = ConfigManager()
        rag = RAGSystem(config)
        assert rag.embedding_model is not None
        stats = rag.get_statistics()
        assert stats['index_size'] == 0  # Empty index initially
        print('✓ RAGSystem tests passed')
        "

    - name: Test API Monitor
      run: |
        python -c "
        from V4.ApiMonitor import SerpAPIMonitor
        from V4.ConfigManager import ConfigManager
        config = ConfigManager()
        monitor = SerpAPIMonitor(config)
        assert monitor.warning_threshold == 100
        assert monitor.critical_threshold == 20
        print('✓ ApiMonitor tests passed')
        "

    - name: Test Article Generator
      run: |
        python -c "
        from V4.ArtGenSys import EnhancedPlantArticleGenerator, ContentCleaner
        from V4.ConfigManager import ConfigManager
        config = ConfigManager()
        cleaning_settings = config.get_content_cleaning_settings()
        cleaner = ContentCleaner(cleaning_settings)
        test_text = '**Bold text** with [1] citations'
        cleaned = cleaner.clean_content(test_text)
        assert '[1]' not in cleaned
        print('✓ ArticleGenerator tests passed')
        "

    - name: Test domain switching
      run: |
        python -c "
        from V4.ConfigManager import ConfigManager
        config = ConfigManager(domain='botany')
        assert config.get_current_domain() == 'botany'
        success = config.switch_domain('medical')
        assert success == True
        assert config.get_current_domain() == 'medical'
        questions = config.get_domain_questions('mathematics')
        assert len(questions) > 0
        print('✓ Domain switching tests passed')
        "

    - name: Run code quality checks
      run: |
        flake8 V4/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 V4/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Generate test coverage report
      run: |
        pytest --version || echo "No pytest tests found, skipping"

    - name: Summary
      run: |
        echo "================================"
        echo "✅ All Research V4 tests passed!"
        echo "================================"
        echo "Python version: ${{ matrix.python-version }}"
        echo "Test environment: Ubuntu Latest"
        echo "Status: SUCCESS"

  integration-test:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Integration test - Full workflow without API
      run: |
        python -c "
        from V4.ConfigManager import ConfigManager
        from V4.FloraDatabase import FloraDatabase
        from V4.RagSys import RAGSystem
        
        print('Running integration test...')
        
        # Initialize all components
        config = ConfigManager(domain='botany', verbose=False)
        db = FloraDatabase(config)
        db.create_default_schema()
        rag = RAGSystem(config)
        
        # Test workflow
        domains = config.get_available_domains()
        print(f'Available domains: {len(domains)}')
        
        for domain in ['botany', 'medical', 'mathematics']:
            config.switch_domain(domain)
            questions = config.get_domain_questions()
            print(f'{domain}: {len(questions)} questions')
        
        print('✅ Integration test passed')
        "

    - name: Test configuration validation
      run: |
        python -c "
        from V4.ConfigManager import ConfigManager
        import json
        from pathlib import Path
        
        config = ConfigManager()
        
        # Validate all config files exist
        config_dir = Path(config.config_dir)
        required_configs = [
            'ai_settings.json',
            'api_monitor.json',
            'config.json',
            'domain_reliability.json',
            'domains.json',
            'search_config.json'
        ]
        
        for cfg_file in required_configs:
            cfg_path = config_dir / cfg_file
            assert cfg_path.exists(), f'Missing config: {cfg_file}'
            
            # Validate JSON
            with open(cfg_path) as f:
                data = json.load(f)
                assert isinstance(data, dict), f'Invalid JSON in {cfg_file}'
        
        print('✅ Configuration validation passed')
        "
