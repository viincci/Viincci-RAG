name: Enhanced Research CLI Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'research_cli.py'
      - 'V4/**'
      - 'requirements.txt'
      - '.github/workflows/test-enhanced-cli.yml'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_domain:
        description: 'Domain to test'
        required: false
        default: 'botany'
        type: choice
        options:
          - botany
          - medical
          - mathematics
          - carpentry
          - art_history
          - literature
          - music
          - creative_writing
      test_format:
        description: 'Output format to test'
        required: false
        default: 'html'
        type: choice
        options:
          - html
          - text
          - json

jobs:
  test-cli-basic:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt

    - name: Create directory structure
      run: |
        mkdir -p V4/config
        mkdir -p V4/db
        mkdir -p _posts

    - name: Make CLI executable
      run: |
        chmod +x research_cli.py

    - name: Test CLI - Help
      run: |
        python research_cli.py --help

    - name: Test CLI - List Domains
      run: |
        python research_cli.py --list-domains

    - name: Test CLI - Domain Info (Botany)
      run: |
        python research_cli.py --domain-info botany

    - name: Test CLI - Domain Info (Medical)
      run: |
        python research_cli.py --domain-info medical

    - name: Test CLI - Add Art Domains
      run: |
        python research_cli.py --add-art-domains

    - name: Test CLI - List Domains After Addition
      run: |
        python research_cli.py --list-domains

    - name: Verify Extended Domains Added
      run: |
        python -c "
        from V4.ConfigManager import ConfigManager
        config = ConfigManager(verbose=False)
        domains = config.get_available_domains()
        
        # Check for extended domains
        extended = ['art_history', 'literature', 'music', 'creative_writing']
        for domain in extended:
            assert domain in domains, f'Extended domain {domain} not found'
            print(f'✓ Found extended domain: {domain}')
        
        # Check original domains still exist
        original = ['botany', 'medical', 'mathematics', 'carpentry']
        for domain in original:
            assert domain in domains, f'Original domain {domain} missing!'
            print(f'✓ Original domain preserved: {domain}')
        
        print('\n✅ All domains verified - backward compatibility maintained')
        "

    - name: Test Output Formatters
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from research_cli import OutputFormatter
        
        # Test HTML formatter (default)
        html_formatter = OutputFormatter('html')
        assert html_formatter.get_file_extension() == '.html'
        print('✓ HTML formatter')
        
        # Test Text formatter
        text_formatter = OutputFormatter('text')
        assert text_formatter.get_file_extension() == '.txt'
        print('✓ Text formatter')
        
        # Test JSON formatter
        json_formatter = OutputFormatter('json')
        assert json_formatter.get_file_extension() == '.json'
        print('✓ JSON formatter')
        
        print('\n✅ All output formatters working')
        "

    - name: Test Creative Writer
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from research_cli import CreativeWriter
        from V4.ConfigManager import ConfigManager
        
        config = ConfigManager(domain='literature', verbose=False)
        writer = CreativeWriter(config, None)
        
        # Test poem generation (without RAG)
        poem = writer.write_poem('roses', 'haiku', None)
        assert 'haiku' in poem.lower()
        print('✓ Poem writer initialized')
        
        # Test essay generation (without RAG)
        essay = writer.write_essay('Shakespeare', 'analytical', None, 1000)
        assert 'essay' in essay.lower()
        print('✓ Essay writer initialized')
        
        print('\n✅ Creative writer working')
        "

    - name: Test Backward Compatibility Functions
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from research_cli import (
            get_extended_domains, 
            check_and_add_extended_domains,
            ensure_backward_compatibility
        )
        from V4.ConfigManager import ConfigManager
        
        # Test get_extended_domains
        extended = get_extended_domains()
        assert 'art_history' in extended
        assert 'literature' in extended
        print('✓ get_extended_domains()')
        
        # Test ensure_backward_compatibility
        config = ConfigManager(verbose=False)
        result = ensure_backward_compatibility(config)
        assert result == True
        print('✓ ensure_backward_compatibility()')
        
        print('\n✅ Backward compatibility functions working')
        "

    - name: Summary
      run: |
        echo "================================"
        echo "✅ All CLI basic tests passed!"
        echo "================================"
        echo "Python version: ${{ matrix.python-version }}"
        echo "Test environment: Ubuntu Latest"
        echo "CLI Status: OPERATIONAL"

  test-output-formats:
    runs-on: ubuntu-latest
    needs: test-cli-basic
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        format: ['html', 'text', 'json']
        domain: ['botany', 'art_history']
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create directory structure
      run: |
        mkdir -p V4/config
        mkdir -p V4/db
        mkdir -p _posts
        mkdir -p test_output

    - name: Test Output Format - ${{ matrix.format }} (${{ matrix.domain }})
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from research_cli import OutputFormatter
        from V4.ConfigManager import ConfigManager
        
        # Test configuration
        format_type = '${{ matrix.format }}'
        domain = '${{ matrix.domain }}'
        
        print(f'Testing {format_type} output for {domain} domain...')
        
        # Create formatter
        formatter = OutputFormatter(format_type)
        
        # Test sample content
        sample_html = '''
        <h2>Introduction</h2>
        <p>This is a test article about plants.</p>
        <h2>Details</h2>
        <p>Plants are amazing organisms.</p>
        '''
        
        metadata = {
            'title': 'Test Article',
            'subtitle': 'Testing output formats',
            'domain': domain,
            'date': '2025-01-01'
        }
        
        # Format content
        formatted = formatter.format_article(sample_html, metadata)
        
        # Verify output
        if format_type == 'html':
            assert '<h2>' in formatted
            assert '<p>' in formatted
        elif format_type == 'text':
            assert '<h2>' not in formatted  # HTML tags removed
            assert 'Test Article' in formatted
            assert domain in formatted
        elif format_type == 'json':
            import json
            parsed = json.loads(formatted)
            assert 'metadata' in parsed
            assert 'sections' in parsed
            assert parsed['metadata']['domain'] == domain
        
        # Check file extension
        ext = formatter.get_file_extension()
        expected_ext = {
            'html': '.html',
            'text': '.txt',
            'json': '.json'
        }
        assert ext == expected_ext[format_type]
        
        print(f'✅ {format_type.upper()} format working correctly for {domain}')
        print(f'   Extension: {ext}')
        print(f'   Output length: {len(formatted)} characters')
        "

    - name: Test Format Conversion
      run: |
        python -c "
        import sys
        import re
        sys.path.insert(0, '.')
        from research_cli import OutputFormatter
        
        html_content = '''
        ---
        layout: post
        title: Test
        ---
        
        <h2>Section 1</h2>
        <p>Paragraph with <strong>bold</strong> text.</p>
        <ul>
          <li>Item 1</li>
          <li>Item 2</li>
        </ul>
        '''
        
        metadata = {'title': 'Test', 'domain': 'test'}
        
        # Test HTML to Text conversion
        text_formatter = OutputFormatter('text')
        text_output = text_formatter.format_article(html_content, metadata)
        
        # Verify HTML tags removed
        assert '<h2>' not in text_output
        assert '<p>' not in text_output
        assert '<ul>' not in text_output
        
        # Verify content preserved
        assert 'Section 1' in text_output
        assert 'Paragraph' in text_output
        
        print('✅ HTML to Text conversion working')
        
        # Test HTML to JSON conversion
        json_formatter = OutputFormatter('json')
        json_output = json_formatter.format_article(html_content, metadata)
        
        import json
        parsed = json.loads(json_output)
        
        # Verify structure
        assert 'metadata' in parsed
        assert 'sections' in parsed
        assert 'full_html' in parsed
        assert len(parsed['sections']) > 0
        
        print('✅ HTML to JSON conversion working')
        "

  test-creative-content:
    runs-on: ubuntu-latest
    needs: test-cli-basic
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create directory structure
      run: |
        mkdir -p V4/config
        mkdir -p V4/db
        mkdir -p _posts

    - name: Test Poem Generation (No RAG)
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from research_cli import CreativeWriter
        from V4.ConfigManager import ConfigManager
        
        config = ConfigManager(domain='literature', verbose=False)
        writer = CreativeWriter(config, rag_system=None)
        
        # Generate poem without RAG (template mode)
        poem = writer.write_poem('nature', 'sonnet', None)
        
        assert len(poem) > 0
        assert 'poem' in poem.lower()
        
        print('✅ Poem generation working (template mode)')
        print(f'Length: {len(poem)} characters')
        "

    - name: Test Essay Generation (No RAG)
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from research_cli import CreativeWriter
        from V4.ConfigManager import ConfigManager
        
        config = ConfigManager(domain='literature', verbose=False)
        writer = CreativeWriter(config, rag_system=None)
        
        # Generate essay without RAG (template mode)
        essay = writer.write_essay('Shakespeare', 'analytical', None, 1000)
        
        assert len(essay) > 0
        assert 'essay' in essay.lower() or 'Essay' in essay
        
        print('✅ Essay generation working (template mode)')
        print(f'Length: {len(essay)} characters')
        "

    - name: Test Creative Content Types
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from research_cli import CreativeWriter
        from V4.ConfigManager import ConfigManager
        
        config = ConfigManager(domain='creative_writing', verbose=False)
        writer = CreativeWriter(config, rag_system=None)
        
        # Test different poem styles
        styles = ['sonnet', 'haiku', 'free verse', 'limerick']
        for style in styles:
            poem = writer.write_poem('sunset', style, None)
            assert style in poem.lower()
            print(f'✓ Poem style: {style}')
        
        # Test different essay types
        essay_types = ['expository', 'argumentative', 'analytical', 'narrative']
        for essay_type in essay_types:
            essay = writer.write_essay('art', essay_type, None, 500)
            assert essay_type in essay.lower()
            print(f'✓ Essay type: {essay_type}')
        
        print('\n✅ All creative content types working')
        "

  test-domain-compatibility:
    runs-on: ubuntu-latest
    needs: test-cli-basic
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create directory structure
      run: |
        mkdir -p V4/config
        mkdir -p V4/db
        mkdir -p _posts

    - name: Test Original Domains Still Work
      run: |
        python -c "
        from V4.ConfigManager import ConfigManager
        
        original_domains = ['botany', 'medical', 'mathematics', 'carpentry', 
                           'engineering', 'chemistry', 'physics', 'computer_science']
        
        for domain in original_domains:
            try:
                config = ConfigManager(domain=domain, verbose=False)
                assert config.get_current_domain() == domain
                
                # Test domain info
                info = config.get_domain_info()
                assert 'name' in info
                assert 'description' in info
                assert 'questions' in info
                
                # Test switching
                config.switch_domain('botany')
                assert config.get_current_domain() == 'botany'
                
                print(f'✓ Domain {domain}: WORKING')
                
            except Exception as e:
                print(f'✗ Domain {domain}: FAILED - {e}')
                exit(1)
        
        print('\n✅ All original domains working - backward compatibility confirmed')
        "

    - name: Test Extended Domains
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from research_cli import ensure_backward_compatibility
        from V4.ConfigManager import ConfigManager
        
        config = ConfigManager(verbose=False)
        ensure_backward_compatibility(config)
        
        extended_domains = ['art_history', 'literature', 'music', 'creative_writing']
        
        for domain in extended_domains:
            try:
                config.switch_domain(domain)
                assert config.get_current_domain() == domain
                
                # Test domain info
                info = config.get_domain_info()
                assert 'name' in info
                assert 'description' in info
                assert 'questions' in info
                assert 'keywords' in info
                
                print(f'✓ Extended domain {domain}: WORKING')
                
            except Exception as e:
                print(f'✗ Extended domain {domain}: FAILED - {e}')
                exit(1)
        
        print('\n✅ All extended domains working')
        "

    - name: Test Domain Switching Between Old and New
      run: |
        python -c "
        from V4.ConfigManager import ConfigManager
        
        config = ConfigManager(domain='botany', verbose=False)
        assert config.get_current_domain() == 'botany'
        print('✓ Started with original domain: botany')
        
        # Switch to extended domain
        config.switch_domain('art_history')
        assert config.get_current_domain() == 'art_history'
        print('✓ Switched to extended domain: art_history')
        
        # Switch back to original
        config.switch_domain('medical')
        assert config.get_current_domain() == 'medical'
        print('✓ Switched back to original domain: medical')
        
        # Switch to another extended
        config.switch_domain('literature')
        assert config.get_current_domain() == 'literature'
        print('✓ Switched to another extended domain: literature')
        
        print('\n✅ Domain switching works seamlessly between old and new domains')
        "

  integration-test:
    runs-on: ubuntu-latest
    needs: [test-cli-basic, test-output-formats, test-domain-compatibility]
    if: github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create directory structure
      run: |
        mkdir -p V4/config
        mkdir -p V4/db
        mkdir -p _posts

    - name: Full Integration Test
      run: |
        python -c "
        import sys
        sys.path.insert(0, '.')
        from research_cli import (
            OutputFormatter, 
            CreativeWriter,
            get_extended_domains,
            check_and_add_extended_domains,
            ensure_backward_compatibility
        )
        from V4.ConfigManager import ConfigManager
        
        print('='*70)
        print('Full Integration Test - Enhanced Research CLI')
        print('='*70)
        
        # Test 1: Backward compatibility
        print('\n1. Testing backward compatibility...')
        config = ConfigManager(verbose=False)
        ensure_backward_compatibility(config)
        original_domains = ['botany', 'medical', 'mathematics', 'carpentry']
        for domain in original_domains:
            assert domain in config.get_available_domains()
        print('   ✓ All original domains present')
        
        # Test 2: Extended domains
        print('\n2. Testing extended domains...')
        extended = get_extended_domains()
        assert len(extended) == 4
        print(f'   ✓ {len(extended)} extended domains available')
        
        # Test 3: Output formatters
        print('\n3. Testing output formatters...')
        for fmt in ['html', 'text', 'json']:
            formatter = OutputFormatter(fmt)
            assert formatter.format_type == fmt
        print('   ✓ All output formatters initialized')
        
        # Test 4: Creative writer
        print('\n4. Testing creative writer...')
        writer = CreativeWriter(config, None)
        poem = writer.write_poem('test', 'haiku', None)
        essay = writer.write_essay('test', 'expository', None, 500)
        assert len(poem) > 0
        assert len(essay) > 0
        print('   ✓ Creative writer functional')
        
        # Test 5: Domain switching
        print('\n5. Testing domain switching...')
        config.switch_domain('art_history')
        assert config.get_current_domain() == 'art_history'
        config.switch_domain('botany')
        assert config.get_current_domain() == 'botany'
        print('   ✓ Domain switching works')
        
        print('\n' + '='*70)
        print('✅ ALL INTEGRATION TESTS PASSED')
        print('='*70)
        "

  final-summary:
    runs-on: ubuntu-latest
    needs: [test-cli-basic, test-output-formats, test-creative-content, test-domain-compatibility]
    if: always()
    
    steps:
    - name: Generate Summary Report
      run: |
        echo "# Enhanced CLI Test Report" > summary.md
        echo "" >> summary.md
        echo "**Test Date:** $(date)" >> summary.md
        echo "" >> summary.md
        
        echo "## Test Results" >> summary.md
        echo "" >> summary.md
        echo "- **Basic CLI Tests:** ${{ needs.test-cli-basic.result }}" >> summary.md
        echo "- **Output Format Tests:** ${{ needs.test-output-formats.result }}" >> summary.md
        echo "- **Creative Content Tests:** ${{ needs.test-creative-content.result }}" >> summary.md
        echo "- **Domain Compatibility Tests:** ${{ needs.test-domain-compatibility.result }}" >> summary.md
        echo "" >> summary.md
        
        echo "## Features Tested" >> summary.md
        echo "" >> summary.md
        echo "### Output Formats" >> summary.md
        echo "- HTML (default)" >> summary.md
        echo "- Plain Text" >> summary.md
        echo "- JSON" >> summary.md
        echo "" >> summary.md
        
        echo "### Content Types" >> summary.md
        echo "- Research Articles" >> summary.md
        echo "- Poems" >> summary.md
        echo "- Essays" >> summary.md
        echo "" >> summary.md
        
        echo "### Domains" >> summary.md
        echo "**Original:** botany, medical, mathematics, carpentry, engineering, chemistry, physics, computer_science" >> summary.md
        echo "" >> summary.md
        echo "**Extended:** art_history, literature, music, creative_writing" >> summary.md
        echo "" >> summary.md
        
        echo "## Backward Compatibility" >> summary.md
        echo "✅ All original domains preserved and functional" >> summary.md
        echo "✅ Extended domains added without breaking existing functionality" >> summary.md
        echo "✅ Domain switching works seamlessly between old and new domains" >> summary.md
        echo "" >> summary.md
        
        echo "---" >> summary.md
        echo "*Generated by GitHub Actions*" >> summary.md
        
        cat summary.md

    - name: Upload Summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: summary.md
        retention-days: 30

    - name: Final Status
      run: |
        echo ""
        echo "========================================="
        echo "Enhanced CLI Test Suite Summary"
        echo "========================================="
        echo ""
        echo "Basic Tests: ${{ needs.test-cli-basic.result }}"
        echo "Format Tests: ${{ needs.test-output-formats.result }}"
        echo "Creative Tests: ${{ needs.test-creative-content.result }}"
        echo "Compatibility Tests: ${{ needs.test-domain-compatibility.result }}"
        echo ""
        
        if [ "${{ needs.test-cli-basic.result }}" = "success" ] && \
           [ "${{ needs.test-output-formats.result }}" = "success" ] && \
           [ "${{ needs.test-domain-compatibility.result }}" = "success" ]; then
          echo "✅ OVERALL STATUS: PASSED"
          echo ""
          echo "The Enhanced CLI is ready for use with:"
          echo "  • Multiple output formats (HTML, Text, JSON)"
          echo "  • Creative content generation (Poems, Essays)"
          echo "  • Extended domains (Art, Literature, Music)"
          echo "  • Full backward compatibility maintained"
          echo "========================================="
          exit 0
        else
          echo "❌ OVERALL STATUS: FAILED"
          echo "Check the individual job logs for details"
          echo "========================================="
          exit 1
        fi
