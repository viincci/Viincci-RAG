name: Test Pip Installation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'setup.py'
      - 'pyproject.toml'
      - 'requirements.txt'
      - 'V4/**'
      - 'MANIFEST.in'
      - '.github/workflows/test-pip-installation.yml'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  release:
    types: [published]

jobs:
  test-build:
    name: Test Package Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install build twine check-manifest

    - name: Check manifest
      run: |
        check-manifest
      continue-on-error: true

    - name: Build package
      run: |
        python -m build
        echo "✅ Package built successfully"

    - name: Check distribution
      run: |
        twine check dist/*
        echo "✅ Distribution check passed"

    - name: List package contents
      run: |
        echo "=== Wheel Contents ==="
        python -m zipfile -l dist/*.whl
        echo ""
        echo "=== Tarball Contents ==="
        tar -tzf dist/*.tar.gz | head -20

    - name: Upload distributions
      uses: actions/upload-artifact@v4
      with:
        name: distributions
        path: dist/
        retention-days: 7

  test-install-wheel:
    name: Test Wheel Installation - Python ${{ matrix.python-version }}
    needs: test-build
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false
    
    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: distributions
        path: dist/

    - name: Install from wheel
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install dist/*.whl
        echo "✅ Wheel installation successful"

    - name: Verify package installation
      shell: bash
      run: |
        python -c "import V4; print(f'✅ V4 package version: {V4.__version__}')"
        python -c "from V4 import ConfigManager; print('✅ ConfigManager imported')"
        python -c "from V4 import FloraDatabase; print('✅ FloraDatabase imported')"
        python -c "from V4 import UniversalResearchSpider; print('✅ Spider imported')"
        python -c "from V4 import RAGSystem; print('✅ RAGSystem imported')"
        python -c "from V4 import UniversalArticleGenerator; print('✅ ArticleGenerator imported')"

    - name: Verify CLI commands
      shell: bash
      run: |
        viincci-research --help || echo "⚠️ viincci-research command not found"
        viincci-test --help || echo "⚠️ viincci-test command not found"

    - name: Check installed files
      shell: bash
      run: |
        python -c "
        import V4
        import os
        from pathlib import Path
        
        v4_path = Path(V4.__file__).parent
        print(f'V4 installed at: {v4_path}')
        
        # Check for config directory
        config_dir = v4_path / 'config'
        if config_dir.exists():
            print(f'✅ Config directory exists')
            config_files = list(config_dir.glob('*.json'))
            print(f'✅ Found {len(config_files)} config files')
        else:
            print('❌ Config directory not found')
            exit(1)
        "

  test-install-source:
    name: Test Source Installation - Python ${{ matrix.python-version }}
    needs: test-build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: distributions
        path: dist/

    - name: Install from source tarball
      run: |
        python -m pip install --upgrade pip
        pip install dist/*.tar.gz
        echo "✅ Source installation successful"

    - name: Verify package installation
      run: |
        python -c "import V4; print(f'✅ V4 package version: {V4.__version__}')"
        python -c "from V4 import ConfigManager, FloraDatabase, RAGSystem; print('✅ All imports successful')"

  test-editable-install:
    name: Test Editable Installation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install in editable mode
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        echo "✅ Editable installation successful"

    - name: Verify editable installation
      run: |
        python -c "import V4; print(f'✅ V4 package version: {V4.__version__}')"
        python -c "from V4 import ConfigManager; c = ConfigManager(verbose=True); print('✅ ConfigManager working')"

    - name: Test CLI in editable mode
      run: |
        viincci-research --list-domains
        echo "✅ CLI working in editable mode"

  test-dependencies:
    name: Test Dependency Installation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install package with dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        echo "✅ Package and dependencies installed"

    - name: Verify core dependencies
      run: |
        python -c "import requests; print('✅ requests')"
        python -c "import bs4; print('✅ beautifulsoup4')"
        python -c "import pandas; print('✅ pandas')"
        python -c "import torch; print('✅ torch')"
        python -c "import transformers; print('✅ transformers')"
        python -c "import sentence_transformers; print('✅ sentence-transformers')"
        python -c "import faiss; print('✅ faiss-cpu')"
        python -c "import PyPDF2; print('✅ PyPDF2')"

    - name: Check optional dependencies
      run: |
        pip list | grep -E "(accelerate|bitsandbytes)" || echo "⚠️ Optional dependencies not installed"

  test-fresh-environment:
    name: Test Fresh Environment Installation
    runs-on: ubuntu-latest
    needs: test-build
    
    steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: distributions
        path: dist/

    - name: Install in fresh environment
      run: |
        python -m pip install --upgrade pip
        pip install dist/*.whl
        echo "✅ Fresh installation complete"

    - name: Run basic functionality test
      run: |
        python -c "
        from V4.ConfigManager import ConfigManager
        
        # Test initialization
        config = ConfigManager(verbose=False)
        print('✅ ConfigManager initialized')
        
        # Test domain operations
        domains = config.get_available_domains()
        assert len(domains) > 0, 'No domains found'
        print(f'✅ Found {len(domains)} domains')
        
        # Test domain switching
        success = config.switch_domain('medical')
        assert success, 'Domain switch failed'
        print('✅ Domain switching works')
        
        # Test configuration access
        questions = config.get_domain_questions()
        assert len(questions) > 0, 'No questions found'
        print(f'✅ Domain has {len(questions)} questions')
        
        print('✅ All basic functionality tests passed')
        "

  test-config-files:
    name: Test Configuration Files Included
    runs-on: ubuntu-latest
    needs: test-build
    
    steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: distributions
        path: dist/

    - name: Install package
      run: |
        pip install dist/*.whl

    - name: Verify config files
      run: |
        python -c "
        from V4.ConfigManager import ConfigManager
        import json
        from pathlib import Path
        
        config = ConfigManager(verbose=False)
        config_dir = Path(config.config_dir)
        
        print(f'Config directory: {config_dir}')
        
        required_configs = [
            'ai_settings.json',
            'api_monitor.json',
            'article_config.json',
            'config.json',
            'domain_reliability.json',
            'domains.json',
            'search_config.json'
        ]
        
        missing = []
        for cfg_file in required_configs:
            cfg_path = config_dir / cfg_file
            if not cfg_path.exists():
                missing.append(cfg_file)
                print(f'❌ Missing: {cfg_file}')
            else:
                # Verify it's valid JSON
                with open(cfg_path) as f:
                    data = json.load(f)
                print(f'✅ Found and validated: {cfg_file}')
        
        if missing:
            print(f'❌ Missing config files: {missing}')
            exit(1)
        else:
            print('✅ All config files present and valid')
        "

  test-readme-examples:
    name: Test README Examples
    runs-on: ubuntu-latest
    needs: test-build
    
    steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Download distributions
      uses: actions/download-artifact@v4
      with:
        name: distributions
        path: dist/

    - name: Install package
      run: |
        pip install dist/*.whl

    - name: Test Python API example
      run: |
        python -c "
        from V4 import ConfigManager, RAGSystem, UniversalArticleGenerator
        
        # Initialize configuration
        config = ConfigManager(domain='mathematics', verbose=False)
        print('✅ ConfigManager initialized')
        
        # Initialize RAG (without loading LLM)
        rag = RAGSystem(config)
        print('✅ RAGSystem initialized')
        
        # Initialize generator (without fetching images)
        generator = UniversalArticleGenerator(config, rag_system=None, fetch_images=False)
        print('✅ ArticleGenerator initialized')
        
        print('✅ README API example works')
        "

  summary:
    name: Installation Test Summary
    runs-on: ubuntu-latest
    needs: [
      test-build,
      test-install-wheel,
      test-install-source,
      test-editable-install,
      test-dependencies,
      test-fresh-environment,
      test-config-files,
      test-readme-examples
    ]
    if: always()
    
    steps:
    - name: Generate summary report
      run: |
        echo "# Pip Installation Test Report" > summary.md
        echo "" >> summary.md
        echo "**Date:** $(date)" >> summary.md
        echo "" >> summary.md
        
        echo "## Test Results" >> summary.md
        echo "" >> summary.md
        echo "- **Package Build:** ${{ needs.test-build.result }}" >> summary.md
        echo "- **Wheel Installation:** ${{ needs.test-install-wheel.result }}" >> summary.md
        echo "- **Source Installation:** ${{ needs.test-install-source.result }}" >> summary.md
        echo "- **Editable Installation:** ${{ needs.test-editable-install.result }}" >> summary.md
        echo "- **Dependency Check:** ${{ needs.test-dependencies.result }}" >> summary.md
        echo "- **Fresh Environment:** ${{ needs.test-fresh-environment.result }}" >> summary.md
        echo "- **Config Files:** ${{ needs.test-config-files.result }}" >> summary.md
        echo "- **README Examples:** ${{ needs.test-readme-examples.result }}" >> summary.md
        echo "" >> summary.md
        
        echo "## Installation Methods Tested" >> summary.md
        echo "- ✅ pip install (wheel)" >> summary.md
        echo "- ✅ pip install (source tarball)" >> summary.md
        echo "- ✅ pip install -e . (editable)" >> summary.md
        echo "" >> summary.md
        
        echo "## Platforms Tested" >> summary.md
        echo "- Ubuntu Latest" >> summary.md
        echo "- macOS Latest" >> summary.md
        echo "- Windows Latest" >> summary.md
        echo "" >> summary.md
        
        echo "## Python Versions Tested" >> summary.md
        echo "- Python 3.9" >> summary.md
        echo "- Python 3.10" >> summary.md
        echo "- Python 3.11" >> summary.md
        echo "" >> summary.md
        
        cat summary.md

    - name: Upload summary
      uses: actions/upload-artifact@v4
      with:
        name: test-summary
        path: summary.md

    - name: Check overall status
      run: |
        echo ""
        echo "========================================="
        echo "Pip Installation Test Summary"
        echo "========================================="
        echo ""
        echo "Build: ${{ needs.test-build.result }}"
        echo "Wheel Install: ${{ needs.test-install-wheel.result }}"
        echo "Source Install: ${{ needs.test-install-source.result }}"
        echo "Editable Install: ${{ needs.test-editable-install.result }}"
        echo "Dependencies: ${{ needs.test-dependencies.result }}"
        echo "Fresh Env: ${{ needs.test-fresh-environment.result }}"
        echo "Config Files: ${{ needs.test-config-files.result }}"
        echo "Examples: ${{ needs.test-readme-examples.result }}"
        echo ""
        
        if [ "${{ needs.test-build.result }}" = "success" ] && \
           [ "${{ needs.test-install-wheel.result }}" = "success" ] && \
           [ "${{ needs.test-install-source.result }}" = "success" ] && \
           [ "${{ needs.test-config-files.result }}" = "success" ]; then
          echo "✅ OVERALL STATUS: PASSED"
          echo "The package is ready for distribution!"
          echo "========================================="
          exit 0
        else
          echo "❌ OVERALL STATUS: FAILED"
          echo "Some installation tests failed"
          echo "========================================="
          exit 1
        fi
